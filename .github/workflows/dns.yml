name: Validate and Update DNS

on:
  pull_request:
    paths: [domains/**]
    types: [opened, synchronize, reopened]
  push:
    paths: [domains/**]
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      is_valid: ${{ steps.validate-schema.outputs.is_valid }}
      changed_files: ${{ steps.get-changes.outputs.all_changed_files }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: get-changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }} ${{ github.sha }} -- domains/)
          else
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD -- domains/)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo "all_changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      - name: Validate JSON schema
        id: validate-schema
        if: steps.get-changes.outputs.all_changed_files != ''
        run: |
          sudo apt-get install -y python3 python3-pip
          pip3 install jsonschema
          
          ALL_VALID=true
          for file in ${{ steps.get-changes.outputs.all_changed_files }}; do
            if [[ -f "$file" && "$file" =~ \.json$ ]]; then
              echo "üîç Validating $file..."
              
              # Validasi 1: Struktur JSON dasar
              if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
                echo "‚ùå $file: Invalid JSON format"
                ALL_VALID=false
                continue
              fi
              
              RECORD_TYPE=$(python3 -c "
              import json, sys
              try:
                  data = json.load(open('$file'))
                  print(data.get('record', {}).get('type', '').upper())
              except:
                  print('ERROR')
              ")
              
              if [[ "$RECORD_TYPE" != "CNAME" && "$RECORD_TYPE" != "A" ]]; then
                echo "‚ùå $file: Hanya CNAME dan A record yang diizinkan. Ditemukan: $RECORD_TYPE"
                ALL_VALID=false
                continue
              fi
              
              if [[ "$RECORD_TYPE" = "CNAME" ]]; then
                VALUE=$(python3 -c "
                import json, re
                data = json.load(open('$file'))
                value = data.get('record', {}).get('value', '')
                print(value)
                ")
                
                if [[ ! "$VALUE" =~ ^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
                  echo "‚ùå $file: Format CNAME value tidak valid: $VALUE"
                  ALL_VALID=false
                fi
              
              elif [[ "$RECORD_TYPE" = "A" ]]; then
                VALUE=$(python3 -c "
                import json, re
                data = json.load(open('$file'))
                value = data.get('record', {}).get('value', '')
                print(value)
                ")
                
                if [[ ! "$VALUE" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
                  echo "‚ùå $file: Format IPv4 address tidak valid: $VALUE"
                  ALL_VALID=false
                else
                  IFS='.' read -r -a OCTETS <<< "$VALUE"
                  for octet in "${OCTETS[@]}"; do
                    if (( octet < 0 || octet > 255 )); then
                      echo "‚ùå $file: Octet tidak valid: $octet"
                      ALL_VALID=false
                    fi
                  done
                fi
              fi
              
              if [[ "$ALL_VALID" = true ]]; then
                echo "‚úÖ $file: Valid"
              fi
            fi
          done
          
          if [[ "$ALL_VALID" = true ]]; then
            echo "is_valid=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Semua file valid!"
          else
            echo "is_valid=false" >> $GITHUB_OUTPUT
            echo "‚ùå Beberapa file tidak valid. Lihat detail di atas."
            exit 1
          fi

  deploy:
    needs: validate
    if: github.event_name == 'push' && needs.validate.outputs.is_valid == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update Cloudflare DNS
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          python3 << 'EOF'
          import os, json, sys
          import requests
          
          ZONE_ID = os.getenv('CLOUDFLARE_ZONE_ID')
          API_TOKEN = os.getenv('CLOUDFLARE_API_TOKEN')
          BASE_URL = "https://api.cloudflare.com/client/v4"
          HEADERS = {
              "Authorization": f"Bearer {API_TOKEN}",
              "Content-Type": "application/json"
          }
          
          changed_files = "${{ needs.validate.outputs.changed_files }}".split()
          
          for file_path in changed_files:
              if not file_path.endswith('.json'):
                  continue
                  
              with open(file_path) as f:
                  config = json.load(f)
              
              subdomain = config['subdomain']
              record_data = config['record']
              
              domain_name = f"{subdomain}.codesigmax.com" if subdomain != '@' else "codesigmax.com"
              
              response = requests.get(
                  f"{BASE_URL}/zones/{ZONE_ID}/dns_records",
                  headers=HEADERS,
                  params={"name": domain_name, "type": record_data['type']}
              )
              
              existing_records = response.json().get('result', [])
              
              payload = {
                  "type": record_data['type'],
                  "name": domain_name,
                  "content": record_data['value'],
                  "ttl": record_data.get('ttl', 3600),
                  "proxied": record_data.get('proxied', record_data['type'] == 'A')
              }
              
              if existing_records:
                  record_id = existing_records[0]['id']
                  response = requests.put(
                      f"{BASE_URL}/zones/{ZONE_ID}/dns_records/{record_id}",
                      headers=HEADERS,
                      json=payload
                  )
                  action = "updated"
              else:
                  response = requests.post(
                      f"{BASE_URL}/zones/{ZONE_ID}/dns_records",
                      headers=HEADERS,
                      json=payload
                  )
                  action = "created"
              
              if response.status_code in [200, 201]:
                  print(f"‚úÖ {record_data['type']} record for {domain_name} {action}")
              else:
                  print(f"‚ùå Failed to {action} {domain_name}: {response.text}")
                  sys.exit(1)
          EOF